"use strict";angular.module("gwf5").service("GWFWebsocketSrvc",["$q","$rootScope","GWFErrorSrvc","GWFLoadingSrvc",function(e,n,o,r){var t=this;return t.SYNC_MSGS={},t.SOCKET=null,t.CONNECTED=!1,t.CONFIG={url:window.GWF_CONFIG.ws_url,autoConnect:!1,reconnect:!0,reconnectTimeout:1e4,keepQueue:!0},t.configure=function(e){if(console.log("WebsocketSrvc.configure()",e),t.CONFIG=e,e.autoConnect)return t.connect()},t.configure(t.CONFIG),t.withConnection=function(n){if(console.log("WebsocketSrvc.withConnection()",n),t.CONFIG.url=n||t.CONFIG.url,t.connected()){var o=e.defer();return o.resolve(),o.promise}return t.connect(n)},t.withConn=function(e){return t.withConnection().then(e,t.connectionFailure)},t.connectionFailure=function(e){return console.log(e),o.showError(e,"Websocket")},t.connect=function(o){o=o||t.CONFIG.url,console.log("WebsocketSrvc.connect()",o);var s=e.defer();if(null==t.SOCKET){r.addTask("wsconnect");var c=t.SOCKET=new WebSocket(o);c.binaryType="arraybuffer",c.onopen=function(){r.stopTask("wsconnect"),t.startQueue(),s.resolve(),t.authenticate().then(function(e){t.CONNECTED=!0,n.$broadcast("gws-ws-open")})},c.onclose=function(){r.stopTask("wsconnect"),t.disconnect(!0),t.CONNECTED&&(t.CONNECTED=!1,n.$broadcast("gws-ws-close"))},c.onerror=function(e){t.disconnect(!0),s.reject("Connection closed")},c.onmessage=function(e){e.data instanceof ArrayBuffer?t.onBinaryMessage(e):t.onMessage(e)}}else s.reject();return s.promise},t.onMessage=function(e){console.log("WebsocketSrvc.onMessage()",e.data),0===e.data.indexOf("ERR:")?o.showError(e.data,"Protocol error"):e.data.indexOf(":MID:")>=0?t.syncMessage(e.data)||t.processMessage(mesage.data):t.processMessage(e.data)},t.onBinaryMessage=function(e){var r=new GWS_Message(e.data);console.log("WebsocketSrvc.onBinaryMessage()",r.dump());var s=r.readCmd(),c=r.isSync()?r.readMid():0,a=s>0?0:r.read16();return c>0&&t.SYNC_MSGS[c]?(a?(o.showError(sprintf("Code: %04X",a).gwsMessage.readString(),"Protocol error"),t.SYNC_MSGS[c].reject(a)):t.SYNC_MSGS[c].resolve(r),void(t.SYNC_MSGS[c]=void 0)):void(a?o.showError(sprintf("Code: %04X",a),"Protocol error"):n.$broadcast("gws-ws-message",r))},t.processMessage=function(e){e.substrUntil(":");n.$broadcast("gws-ws-message",e)},t.disconnect=function(e){null!=t.SOCKET&&(t.SOCKET.close(),t.SOCKET=null,t.SYNC_MSGS={},e&&n.$broadcast("gws-ws-disconnect"))},t.connected=function(){return!!t.SOCKET},t.authenticate=function(){var e=t;return e.sendBinary(GWS_Message().cmd(1).sync().writeString(window.GWF_CONFIG.ws_secret)).then(e.authenticated,e.authFailure)},t.authenticated=function(e){window.GWF_USER.update(JSON.parse(e))},t.authFailure=function(e){o.showError(e,"Websocket Authentication")},t.syncMessage=function(e){var n=explode(":",e,4);n[0];if("MID"!==n[1])return!1;var o=n[2],r=n[3];return t.SYNC_MSGS[o]&&(t.SYNC_MSGS[o].resolve(r),t.SYNC_MSGS[o]=void 0),!0},t.startQueue=function(){null===t.QUEUE_INTERVAL&&(t.QUEUE_INTERVAL=setInterval(t.flushQueue,t.QUEUE_SEND_MILLIS))},t.flushQueue=function(){t.connected()&&t.sendQueue()},t.sendQueue=function(){t.QUEUE.length>0},t.sendCommand=function(n,o,r){var s=e.defer();if(t.connected()){if(!r){var c=GWS_Message.nextMid();t.SYNC_MSGS[c]=s,o=sprintf("MID:%s:%s",c,o)}t.send(n+":"+o),r&&s.resolve()}else s.reject();return s.promise},t.send=function(e){console.log("WebsocketSrvc.send()",e),t.SOCKET.send(e)},t.sendBinary=function(n){var o=e.defer();return t.connected()?(n.SYNC>0?t.SYNC_MSGS[n.SYNC]=o:o.resolve(),console.log("WebsocketSrvc.sendBinary()",n.dump()),t.SOCKET.send(n.binaryBuffer())):o.reject(),o.promise},t}]);